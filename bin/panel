#!/bin/bash
#
# Bar Ain't Recursive panel
# by Ivan Sokolov
#
# Final version, 21.02.15
#

WHITE=f8f8f8
# WHITE=202020
RED=a54242
GREEN=8c9440
BLACK=202020
GRAY=404040

function A {
	echo -n "%{A:$2:}$1%{A}"
}

function B {
	echo -n "%{B#$2}$1%{B-}"
}

function F {
	echo -n "%{F#$2}$1%{F-}"
}

function o {
	echo -n "%{+o}$1%{-o}"
}

function u {
	echo -n "%{+u}$1%{-u}"
}

###

DIV=$(F '][' ff$WHITE)

###

network() {
	ping -c 1 8.8.8.8 >/dev/null 2>&1 && echo -n $(F + ff00d000) || echo -n $(F - ffd00000)
}

calendar() {
	DATE=$(date -u +%d/%m/%y)
	echo -n $(F $DATE ff$WHITE)
}

clock() {
	TIME=$(date -u +%H:%M)
	echo -n $(F $TIME ff$WHITE)
}

volume() {
	VOLUME=$(pamixer --get-volume)
	if [[ $(pamixer --get-mute) -eq 'true' ]]
	then
		VCOLOR=ff$WHITE
	else
		VCOLOR=ff$GRAY
	fi
	echo -n "$(A $(F $VOLUME $VCOLOR) volume)"
}

battery() {
	BATTERY=$(acpi -b | awk '{gsub(/%,/,""); print $4}' | sed 's/%//g')
	if [[ $BATTERY -gt 20 ]]
	then
		BCOLOR=ff$WHITE
	else
		BCOLOR=ff$RED
	fi
	echo -n $(F $BATTERY $BCOLOR)
}

layout() {
	echo -n "$(A $(F $(xkb-switch) ff$WHITE) layout)"
}

mpc_status() {
	if [[ -n $(mpc | grep playing) ]]
	then
		echo -n "$(F "$(mpc current -f "[%title%]")" ff$WHITE) $DIV "
		echo -n "$(F "$(mpc current -f "[%album%]")" ff$WHITE) $DIV "
		echo -n "$(F "$(mpc current -f "[%artist%|%albumartist%|%performer%]")" ff$WHITE) "
	else
		echo -n ''
	fi
}

# It's was good idea, but I'm lazy
mpc_controls() {
	echo -n ''
}

SPACER=$(F '--' 00$BLACK)

desktops() {
	for i in $(bspc query -D | tr "\n" " ")
	do
		printf '%s' "%{A:$i:}$SPACER$(F $i ff$WHITE)$SPACER%{A}"
	done
}

while true
do
	# Left
	printf '%s' '%{l}'
	desktops
	
	# Center
	#printf '%s' '%{c}' "$(mpc_status)" "$(mpc_controls)"
	#printf '%s' "$(mpc_status)"
	#printf '%s' "$(mpc_controls)"
	
	# Right
	printf '%s' "%{r}$(F '[' ff$WHITE)"
	printf ' %s' $(network) $DIV 
	printf ' %s' $(layout) $DIV
	printf ' %s' $(volume) $DIV 
	#printf ' %s' $(battery) $DIV 
	printf ' %s' $(clock)
	printf ' %s' $(calendar) $DIV
	printf ' %s \n' "$(A "$(F "*" "ffd00000")" 'bspc quit')$(F ' ]' ff$WHITE)"

	sleep 0.5s
done | lemonbar | spawner
