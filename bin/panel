#!/bin/bash

FG=$(gxc fg ff)
RED=$(gxc red ff)
GREEN=$(gxc boldgreen ff)
BG=$(gxc bg ff)
GRAY=$(gxc boldblack ff)

# Clickable area
function A {
	[[ -n $2 ]] && echo -n "%{A:$2:}${1}%{A}"
}

# Background color
function B {
	[[ -n $2 ]] && echo -n "%{B#$2}${1}%{B-}"
}

# Foreground color
function F {
	[[ -n $2 ]] && echo -n "%{F#$2}${1}%{F-}"
}

# Overlined (?) text
function o {
	[[ -n $1 ]] && echo -n "%{+o}${1}%{-o}"
}

# Underlined text
function u {
	[[ -n $1 ]] && echo -n "%{+u}${1}%{-u}"
}

###

DIV=$(F \| $GRAY)
SPACER=$(F -- $BG)

###

network() {
	ping -c 1 8.8.8.8 >/dev/null 2>&1 \
		&& echo -n $(F + $GREEN) \
		|| echo -n $(F - $RED)
}

datetime() {
	echo -n $(date -u '+%H.%M %d/%m/%y')
}

volume() {
	VOLUME=$(pamw --get)
	echo -n $(A $(F $VOLUME $FG) volume)
}

battery() {
	BATTERY=$(acpi -b | awk '{gsub(/%,/,""); print $4}' | sed 's/%//g')
	if [[ $BATTERY -gt 20 ]]
	then
		BCOLOR=$FG
	else
		BCOLOR=$RED
	fi
	echo -n $(F $BATTERY $BCOLOR)
}

layout() {
	echo -n $(A $(F $(xkb-switch) $FG) layout)
}

mpc_status() {
	if [[ -n $(mpc | grep playing) ]]
	then
		echo -n "$(F "$(mpc current -f "[%title%]")" $FG) $DIV "
		echo -n "$(F "$(mpc current -f "[%album%]")" $FG) $DIV "
		echo -n "$(F "$(mpc current -f "[%artist%|%albumartist%|%performer%]")" $FG) "
	else
		echo -n ''
	fi
}

# It's was good idea, but I'm too lazy
mpc_controls() {
	echo -n ''
}

desktops() {
	for i in $(bspc query -D | tr '\n' ' ')
	do
		printf '%s' "%{A:$i:}$SPACER$(F $i $FG)$SPACER%{A}"
	done
}

bspc config top_padding 30

while true
do
	# Left
	printf '%s' '%{l}'
	desktops
	
	# Center
	#printf '%s' '%{c}' "$(mpc_status)" "$(mpc_controls)"
	#printf '%s' "$(mpc_status)"
	#printf '%s' "$(mpc_controls)"
	
	# Right
	printf '%s' "%{r}"
	printf ' %s' $(network) $DIV 
	printf ' %s' $(layout) $DIV
	printf ' %s' $(volume) $DIV 
	printf ' %s' $(battery) $DIV 
	printf ' %s' $(datetime) $DIV
	printf ' %s \n' "$(A "$(F x $RED)" 'bspc quit') "

	sleep 0.5s
 done | lemonbar \
	-g '1346x20+10+10' \
	-B $(gxc background \#) \
	-F $(gxc foreground \#) \
	-f '-*-uushi-*-*-*-11-*-*-*-*-*-*-*' \
	| spawner
